<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>YT → Audio (descarga directa)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#0f172a">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <header class="topbar">
    <div class="brand"><span class="disc">●</span> YT → Audio</div>
    <nav>
      <a href="https://ffmpeg.org/" target="_blank" rel="noopener">FFmpeg</a>
      <a href="https://github.com/yt-dlp/yt-dlp" target="_blank" rel="noopener">yt-dlp</a>
    </nav>
  </header>

  <main class="container">
    {% if on_render %}
      <div class="banner-warning">
        <strong>Nota:</strong> Estás en un host de datacenter (Render). YouTube puede pedir verificación.
        Usa <b>cookies</b> de tu navegador (estando logueado) y, si persiste, configura un <b>proxy residencial</b>.
        {% if proxy %}<span class="ok">Proxy activo.</span>{% endif %}
      </div>
    {% endif %}

    <section class="hero">
      <h1>Descarga directa de audio</h1>
      <p>Pega la URL, elige formato y baja el audio. No se guarda nada en el servidor.</p>
    </section>

    <section class="card">
      <form id="dl-form" class="grid" method="post" action="/download" enctype="multipart/form-data">
        <div class="field wide">
          <label for="url">URL de YouTube</label>
          <input type="url" id="url" name="url" placeholder="https://www.youtube.com/watch?v=..." required>
        </div>

        <div class="field">
          <label for="codec">Formato</label>
          <select id="codec" name="codec">
            <option value="mp3" selected>MP3</option>
            <option value="m4a">M4A (AAC)</option>
            <option value="opus">Opus</option>
          </select>
        </div>

        <div class="field">
          <label for="quality">Calidad (kbps)</label>
          <select id="quality" name="quality">
            <option value="128">128</option>
            <option value="160">160</option>
            <option value="192" selected>192</option>
            <option value="256">256</option>
            <option value="320">320</option>
          </select>
        </div>

        <div class="field checkbox wide">
          <label><input type="checkbox" id="use_cookies" name="use_cookies"> Usar cookies</label>
          <small>Recomendado en Render / hosts cloud.</small>
        </div>

        <div class="field wide" id="cookies_uploader" style="display:none;">
          <label for="cookies_file">Subir cookies.txt</label>
          <input type="file" id="cookies_file" name="cookies_file" accept=".txt">
          <small>Puedes exportarlas con extensiones tipo “Get cookies.txt”.</small>
        </div>

        <div class="field wide" id="cookies_paster" style="display:none;">
          <label for="cookies_text">O pegar cookies aquí</label>
          <textarea id="cookies_text" name="cookies_text" rows="6" placeholder="# Netscape HTTP Cookie File…"></textarea>
          <small>Pega el contenido de tu cookies.txt (formato Netscape).</small>
        </div>

        <div class="actions wide">
          <button type="submit" id="btn-download">Descargar ahora</button>
          <button type="button" id="btn-reset" class="ghost">Limpiar</button>
        </div>
      </form>
    </section>

    <section id="status" class="status" hidden>
      <div class="spinner"></div>
      <div class="status-text">
        <strong>Preparando tu audio…</strong>
        <small>Extrayendo el mejor audio y convirtiendo con FFmpeg.</small>
      </div>
    </section>

    <section class="tips">
      <details>
        <summary>Cómo exportar cookies</summary>
        <ol>
          <li>Instala “Get cookies.txt” en tu navegador.</li>
          <li>Abre YouTube <em>logueado</em>, exporta las cookies del dominio.</li>
          <li>Sube el archivo o pega su contenido aquí.</li>
        </ol>
      </details>
      <details>
        <summary>¿Aún te marca “Sign in to confirm you’re not a bot”?</summary>
        <ul>
          <li>Verifica que las cookies sean recientes (vuelve a exportarlas).</li>
          <li>Activa un <b>proxy residencial</b> en la variable <code>YTDLP_PROXY</code> (HTTP/SOCKS).</li>
          <li>Evita VPNs de datacenter gratuitas (suelen estar bloqueadas).</li>
        </ul>
      </details>
      <p class="legal">Usa conforme a leyes y términos aplicables.</p>
    </section>
  </main>

  <footer class="footer">
    Flask + yt-dlp · Descarga directa
  </footer>

  <script>
    const ck = document.getElementById('use_cookies');
    const up = document.getElementById('cookies_uploader');
    const ps = document.getElementById('cookies_paster');
    ck.addEventListener('change', () => {
      const show = ck.checked;
      up.style.display = show ? 'block' : 'none';
      ps.style.display = show ? 'block' : 'none';
    });

    const form = document.getElementById('dl-form');
    const statusBox = document.getElementById('status');
    const btnDownload = document.getElementById('btn-download');
    const btnReset = document.getElementById('btn-reset');

    btnReset.addEventListener('click', () => {
      form.reset();
      up.style.display = 'none';
      ps.style.display = 'none';
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusBox.hidden = false;
      btnDownload.disabled = true;

      try {
        const body = new FormData(form);
        const resp = await fetch(form.action, { method: 'POST', body });

        if (!resp.ok) {
          try { const data = await resp.json(); alert(data.error || 'Error de descarga.'); }
          catch { alert('Error de descarga.'); }
          return;
        }

        const blob = await resp.blob();
        const cd = resp.headers.get('Content-Disposition') || '';
        let fname = 'audio';
        const match = /filename="([^"]+)"/i.exec(cd);
        if (match && match[1]) fname = match[1];

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = fname; document.body.appendChild(a); a.click();
        a.remove(); URL.revokeObjectURL(url);
      } catch (err) {
        alert('Ocurrió un error: ' + err);
      } finally {
        statusBox.hidden = true;
        btnDownload.disabled = false;
      }
    });
  </script>
</body>
</html>
